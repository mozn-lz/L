<%- include('./frame/header.ejs') %>
<%- include('./frame/menu.ejs') %>

<style>
	form {
		display: grid;
		place-items: center;
		padding-bottom: 30px;
	}
	
	.form-group {
		margin-bottom: 15px;
	}

	fieldset {
		padding-bottom: 20px;
	}
</style>
<div id="main">
	<h2 class="text-center">Contact & Password</h2>
	<form id="registerForm">
		<ul class="nav nav-pills mb-3" id="pills-tab" role="tablist">
			<li class="nav-item" role="presentation">
				<button class="nav-link active" id="pills-contact-tab" data-bs-toggle="pill" data-bs-target="#pills-contact" type="button" role="tab" aria-controls="pills-contact" aria-selected="false">Contact</button>
			</li>
			<li class="nav-item" role="presentation">
				<button class="nav-link" id="pills-password-tab" data-bs-toggle="pill" data-bs-target="#pills-password" type="button" role="tab" aria-controls="pills-password" aria-selected="false">Password</button>
			</li>
		</ul>
		<div class="tab-content" id="pills-tabContent">
			<div class="tab-pane fade show active" id="pills-contact" role="tabpanel" aria-labelledby="pills-contact-tab">
				<fieldset class="row">
					<legend>Change Contact</legend>
					<div class="form-group col-sm-12">
						<label for="email">Email</label>
						<input class="form-control" type="email" name="email" id="email" placeholder="Email">
					</div>
					<div class="input-group mb-3">
						<span class="input-group-text" id="basic-addon1">+266&nbsp;</span>
						<input type="text" class="form-control" placeholder="5876 5432" id="lesotho_cell" aria-label="les">
					</div>
					<div class="input-group mb-3">
						<span class="input-group-text" id="basic-addon1">+27(0)</span>
						<input type="text" class="form-control" id="cell" placeholder="987 654 32" aria-label="cell">
					</div>
					<!-- todo add confirmation code [email or sms] -->
				</fieldset>
			</div>
			<div class="tab-pane fade" id="pills-password" role="tabpanel" aria-labelledby="pills-password-tab">
				<fieldset class="col-sm-6 row">
					<legend>Change Password</legend>
					<div class="form-group">
						<label for="old_password">old_password</label>
						<input class="form-control" type="old_password" name="old_password" id="old_password" placeholder="old_password" required>
					</div>
					<br>
					<div class="form-group">
						<label for="password">Password</label>
						<input class="form-control" type="password" name="password" id="password" placeholder="Password" required>
					</div>
					<div class="form-group">
						<label for="Confirm-Password">Confirm Password</label>
						<input class="form-control" type="password" name="confirmPassword" id="confirmPassword" placeholder="Confirm Password" required>
					</div>
				</fieldset>
			</div>
		</div>

		<input type="hidden" name="update_personal" value="true">
		<input type="hidden" name="id" value="">
		<button class="btn btn-primary " type="submit">Update</button>
	</form>
</div>

<script>
		let name = () => /^[a-zA-Z]{3,14}\w$/.test($('#name').val().trim());
		let surname = () => /^[a-zA-Z]{3,14}\w$/.test($('#surname').val().trim());
		let email = () => /^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/.test($('#email').val().trim());
		let cell = () => /^[\+]?[(]?[0-9]{3}[)]?[-\s\.]?[0-9]{3}[-\s\.]?[0-9]{4,6}$/im.test($('#cell').val().trim());
		let lesotho_cell = () => /^[0-9]{4}[-\s\.]?[0-9]{4}$/im.test($('#lesotho_cell').val().trim());
		let password = () => /^(?=.*[a-z])(?=.*[A-Z])(?=.*[0-9])(?=.*[!@#\$%\^&\*])(?=.{8,})/.test($('#password').val());
		let password2 = () => ($('#confirmPassword').val() == $('#password').val());
		$('#registerForm').submit((e) => {
				e.preventDefault();

				console.log('necpp', name(), email(), cell(), password(), password2());

				$.ajax({
						url: 'http://localhost:3000/users/',
						type: 'POST',
						data: $('#registerForm').serialize(),
						success: (result) => {
								console.log('successfully registered');
								const showMessage = $('#showMessage');
								if (result.success) {
										showMessage.html(`
											<div class="alert alert-success alert-dismissible fade show" role="alert">
												<div>Welcome...</div>
											</div>`);
										$(location).attr('href', '/login');
								} else {
										let msg = '';
										result.msg ? msg = msg = result.msg : msg = 'Invalid credentials';
										showMessage.html(`
											<div class="alert alert-danger alert-dismissible fade show" role="alert">
												<div">${msg}</div>
											</div>`);
								}
								showMessage.show(2000);
								setTimeout(() => {
										showMessage.hide(2000);
								}, 5000);
						},
						error: (e) => {
								console.log('Error: ', e);
						}
				});
		});

		// (email || cell) ?
		$('#name').keyup(() => {
				name() ? ($('#name').css('border', '#198754 solid 2px')) : ($('#name').css('border', '#dc3545 solid 2px'));
		});
		$('#surname').keyup(() => {
			surname() ? ($('#surname').css('border', '#198754 solid 2px')) : ($('#surname').css('border', '#dc3545 solid 2px'));
		});
		$('#password').keyup(() => {
				password() ? ($('#password').css('border', '#198754 solid 2px')) : ($('#password').css('border', '#dc3545 solid 2px'));
		});
		$('#confirmPassword').keyup(() => {
				password2() ? ($('#confirmPassword').css('border', '#198754 solid 2px')) : ($('#confirmPassword').css('border', '#dc3545 solid 2px'));
		});
		$('#email').keyup(() => {
				email() ? ($('#email').css('border', '#198754 solid 2px')) : ($('#email').css('border', '#dc3545 solid 2px'));
		});
		$('#lesotho_cell').keyup(() => {
				lesotho_cell() ? ($('#lesotho_cell').css('border', '#198754 solid 2px')) : ($('#lesotho_cell').css('border', '#dc3545 solid 2px'));
		});
		$('#cell').keyup(() => {
				cell() ? ($('#cell').css('border', '#198754 solid 2px')) : ($('#cell').css('border', '#dc3545 solid 2px'));
		});
</script>
<%- include('./frame/footer.ejs') %>